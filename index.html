<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Face ID V17 - Multi-Face Tracking</title>
<style>
    :root { --neon: #00ff99; --bg: #050505; --panel: #111; --wait: #ffcc00; --danger: #ff4444; }
    body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
    .layout { display: flex; width: 100vw; height: 100vh; }
    
    #cam-area { position: relative; flex-grow: 1; background: #000; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); position: absolute; }
    canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 5; }

    #panel { width: 360px; background: var(--panel); border-left: 1px solid #333; padding: 25px; z-index: 10; display: flex; flex-direction: column; gap: 15px; }
    .card { background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; position: relative;}
    h3 { margin: 0 0 10px 0; color: var(--neon); font-size: 14px; text-transform: uppercase; }

    input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: var(--neon); border-radius: 5px; outline: none; box-sizing: border-box; margin-bottom: 5px;}
    #msg-error { color: var(--danger); font-size: 11px; min-height: 15px; display: block; margin-bottom: 10px; }
    
    .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
    .btn-scan { background: var(--neon); color: #000; }
    .btn-scan:disabled { background: #333; color: #666; cursor: not-allowed; }

    .step-box { margin-top: 15px; display: none; }
    .step-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: #555; font-size: 13px; }
    .step-item.active { color: var(--wait); font-weight: bold; }
    .step-item.done { color: var(--neon); }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: currentColor; }

    #instruction-big { 
        position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
        z-index: 10; background: rgba(0,0,0,0.85); padding: 15px 30px; border-radius: 50px;
        border: 2px solid var(--neon); font-size: 20px; font-weight: bold; color: var(--neon);
        display: none; text-align: center; box-shadow: 0 0 20px rgba(0,255,153,0.3);
    }
</style>
</head>
<body>

<div id="instruction-big">HỆ THỐNG SẴN SÀNG</div>

<div class="layout">
    <div id="cam-area">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="panel">
        <div class="card">
            <h3>Đăng ký thực thể mới</h3>
            <input type="text" id="nameInput" placeholder="Nhập tên người dùng...">
            <span id="msg-error"></span>
            <button id="scanBtn" class="btn btn-scan" onclick="startStepByStep()">QUÉT ĐA CHIỀU (3D)</button>
            
            <div id="step-container" class="step-box">
                <div class="step-item" id="step0"><div class="dot"></div> Bước 1: Nhìn thẳng</div>
                <div class="step-item" id="step1"><div class="dot"></div> Bước 2: Nghiêng trái</div>
                <div class="step-item" id="step2"><div class="dot"></div> Bước 3: Nghiêng phải</div>
                <div class="step-item" id="step3"><div class="dot"></div> Bước 4: Cúi mặt</div>
                <div class="step-item" id="step4"><div class="dot"></div> Bước 5: Ngước mặt</div>
            </div>
        </div>

        <div class="card">
            <div style="font-size: 12px; color: #888; line-height: 1.8;">
                • Mẫu dữ liệu lưu trữ: <span id="dbSize" style="color:var(--neon)">0</span><br>
                • Phát hiện trong khung: <span id="activeCount" style="color:var(--neon)">0</span> đối tượng
            </div>
        </div>

        <div id="log" style="flex-grow: 1; background: #000; padding: 10px; font-size: 11px; color: #888; border-radius: 5px; overflow-y: auto; font-family: monospace; border: 1px solid #222;"></div>
        <button class="btn" style="background:#222; color:#555; font-size:10px; height: 35px; padding: 0;" onclick="clearDB()">RESET DATABASE</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const logBox = document.getElementById('log');
const nameInput = document.getElementById('nameInput');
const scanBtn = document.getElementById('scanBtn');
const bigMsg = document.getElementById('instruction-big');
const msgError = document.getElementById('msg-error');

let facesDB = JSON.parse(localStorage.getItem('facesDB_V17') || '[]');
let currentStep = -1; 
let samplePerStep = 12; 
let currentSampleCount = 0;
let isWaitingForNext = false;

const steps = [
    { label: "GIỮ MẶT THẲNG", check: (y, p) => y > 0.85 && y < 1.15 && p > 0.85 && p < 1.15 },
    { label: "XOAY MẶT SANG TRÁI", check: (y, p) => y < 0.7 },
    { label: "XOAY MẶT SANG PHẢI", check: (y, p) => y > 1.5 },
    { label: "CÚI ĐẦU XUỐNG", check: (y, p) => p > 1.6 },
    { label: "NGỬA ĐẦU LÊN", check: (y, p) => p < 0.6 }
];

async function start() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
    video.srcObject = stream;
    video.onloadedmetadata = () => { canvas.width = video.videoWidth; canvas.height = video.videoHeight; runAI(); };
}

const faceMesh = new FaceMesh({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}` });
faceMesh.setOptions({ maxNumFaces: 10, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

faceMesh.onResults(res => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('dbSize').innerText = facesDB.length;

    if (res.multiFaceLandmarks) {
        document.getElementById('activeCount').innerText = res.multiFaceLandmarks.length;
        
        res.multiFaceLandmarks.forEach((lm, index) => {
            const vector = getVector(lm);
            
            // Tính toán tư thế
            const nose = lm[1], left = lm[33], right = lm[263], top = lm[10], bot = lm[152];
            const yaw = Math.abs(nose.x - left.x) / Math.abs(nose.x - right.x);
            const pitch = Math.abs(nose.y - top.y) / Math.abs(nose.y - bot.y);

            // Xử lý logic ĐĂNG KÝ (chỉ dành cho người gần cam nhất - index 0)
            if (currentStep !== -1 && index === 0) {
                processScanning(yaw, pitch, vector);
                drawUI(lm, "ĐANG LẤY MẪU...", "#ffcc00");
            } 
            // Xử lý logic NHẬN DIỆN đa đối tượng
            else {
                let match = { name: "Người lạ", dist: 100 };
                facesDB.forEach(db => {
                    const d = calcDist(vector, db.vector);
                    if (d < match.dist) { match.dist = d; match.name = db.name; }
                });

                const isRecognized = match.dist < 0.62;
                drawUI(lm, isRecognized ? match.name : "Người lạ", isRecognized ? "#00ff99" : "#ff4444");
            }
        });
    } else {
        document.getElementById('activeCount').innerText = "0";
    }
});

function processScanning(yaw, pitch, vector) {
    if (isWaitingForNext) return;
    const target = steps[currentStep];
    bigMsg.style.display = 'block';
    bigMsg.innerText = target.label;

    if (target.check(yaw, pitch)) {
        currentSampleCount++;
        bigMsg.innerText = `${target.label} (${Math.round(currentSampleCount/samplePerStep*100)}%)`;
        facesDB.push({ name: nameInput.value, vector: vector });

        if (currentSampleCount >= samplePerStep) {
            isWaitingForNext = true;
            document.getElementById(`step${currentStep}`).className = 'step-item done';
            currentStep++;
            currentSampleCount = 0;

            if (currentStep < steps.length) {
                bigMsg.innerText = "TUYỆT VỜI! CHỜ ĐỔI GÓC...";
                setTimeout(() => {
                    isWaitingForNext = false;
                    document.getElementById(`step${currentStep}`).className = 'step-item active';
                }, 1200);
            } else {
                finishAll();
            }
        }
    }
}

function startStepByStep() {
    if (!nameInput.value.trim()) {
        msgError.innerText = "VUI LÒNG NHẬP TÊN TRƯỚC!";
        setTimeout(() => msgError.innerText = "", 3000);
        return;
    }
    currentStep = 0; isWaitingForNext = false; scanBtn.disabled = true;
    document.getElementById('step-container').style.display = 'block';
    document.getElementById('step0').className = 'step-item active';
    addLog(`BẮT ĐẦU THIẾT LẬP CHO: ${nameInput.value}`);
}

function finishAll() {
    currentStep = -1;
    bigMsg.innerText = "ĐÃ LƯU DANH TÍNH!";
    localStorage.setItem('facesDB_V17', JSON.stringify(facesDB));
    setTimeout(() => {
        bigMsg.style.display = 'none';
        scanBtn.disabled = false;
        document.getElementById('step-container').style.display = 'none';
        for(let i=0; i<5; i++) document.getElementById(`step${i}`).className = 'step-item';
    }, 2000);
}

function getVector(lm) {
    // 32 điểm trọng yếu bao phủ khối 3D mặt
    const anchors = [1,10,152,33,263,61,291,199,4,127,356,132,361,70,300,103,332,123,352,58,288,168,197,5,21,251,127,356,143,372,132,361];
    const d = Math.hypot(lm[33].x - lm[263].x, lm[33].y - lm[263].y);
    const cx = (lm[33].x + lm[263].x) / 2, cy = (lm[33].y + lm[263].y) / 2;
    return anchors.flatMap(i => [(lm[i].x - cx)/d, (lm[i].y - cy)/d, (lm[i].z)/d]);
}

function calcDist(v1, v2) { return Math.sqrt(v1.reduce((s, v, i) => s + (v - v2[i])**2, 0)); }

function drawUI(lm, label, color) {
    let xMin = 1, xMax = 0, yMin = 1, yMax = 0;
    lm.forEach(p => { xMin = Math.min(xMin, p.x); xMax = Math.max(xMax, p.x); yMin = Math.min(yMin, p.y); yMax = Math.max(yMax, p.y); });
    const x = canvas.width - (xMax * canvas.width), y = yMin * canvas.height;
    const w = (xMax - xMin) * canvas.width, h = (yMax - yMin) * canvas.height;
    
    // Khung nhận diện
    ctx.strokeStyle = color; ctx.lineWidth = 3;
    ctx.strokeRect(x, y, w, h);
    
    // Tag tên
    ctx.fillStyle = color;
    ctx.font = "bold 18px Segoe UI";
    ctx.fillText(label.toUpperCase(), x, y - 10);
}

function addLog(m) { const e = document.createElement('div'); e.style.marginBottom="5px"; e.innerText = `> ${m}`; logBox.prepend(e); }
function clearDB() { localStorage.removeItem('facesDB_V17'); location.reload(); }
async function runAI() { if (video.readyState >= 2) await faceMesh.send({ image: video }); requestAnimationFrame(runAI); }
start();
</script>
</body>
</html>