<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Finger Counter Speak EN</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: Arial, sans-serif;
  }

  /* GIỮ ĐÚNG TỈ LỆ CAM – KHÔNG BỊ ÉP */
  video, canvas {
    position: absolute;
    top: 50%;
    left: 50%;
    max-width: 100vw;
    max-height: 100vh;
    width: auto;
    height: auto;
    transform: translate(-50%, -50%) scaleX(-1);
    object-fit: contain;
  }

  #number {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 80px;
    font-weight: 900;
    color: #ff69b4;
    text-shadow:
      0 0 10px rgba(255,105,180,.7),
      0 0 25px rgba(255,105,180,.9);
    z-index: 10;
    user-select: none;
  }
</style>
</head>
<body>

<div id="number">0</div>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const numberEl = document.getElementById("number");

/* ===== SPEAK EN ===== */
const speakMap = [
  "zero","one","two","three","four",
  "five","six","seven","eight","nine","ten"
];

let lastSpoken = -1;
let lastSpeakTime = 0;

function speakNumber(n) {
  const now = performance.now();
  if (n === lastSpoken) return;
  if (now - lastSpeakTime < 800) return;

  const utter = new SpeechSynthesisUtterance(speakMap[n] || n.toString());
  utter.lang = "en-US";
  utter.rate = 0.9;

  speechSynthesis.cancel();
  speechSynthesis.speak(utter);

  lastSpoken = n;
  lastSpeakTime = now;
}

/* ===== COUNT FINGERS ===== */
function countFingers(lm, handedness) {
  let c = 0;

  if (lm[8].y  < lm[6].y)  c++;
  if (lm[12].y < lm[10].y) c++;
  if (lm[16].y < lm[14].y) c++;
  if (lm[20].y < lm[18].y) c++;

  if (handedness === "Right") {
    if (lm[4].x < lm[3].x) c++;
  } else {
    if (lm[4].x > lm[3].x) c++;
  }
  return c;
}

/* ===== STABLE ===== */
let stable = 0, last = 0, frame = 0;

/* ===== HANDS ===== */
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 2,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(res => {
  if (!canvas.width || !canvas.height) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);

  let total = 0;
  if (res.multiHandLandmarks) {
    res.multiHandLandmarks.forEach((lm, i) => {
      const hand = res.multiHandedness[i].label;
      total += countFingers(lm, hand);
      drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:"#00ffff", lineWidth:4});
      drawLandmarks(ctx, lm, {color:"#ff3333", radius:5});
    });
  }

  if (total === last) {
    frame++;
    if (frame > 5) stable = total;
  } else frame = 0;
  last = total;

  numberEl.innerText = stable;
  speakNumber(stable);
});

/* ===== CAMERA ===== */
const camera = new Camera(video, {
  onFrame: async () => {
    if (video.videoWidth && video.videoHeight) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }
    await hands.send({ image: video });
  },
  width: 1280,
  height: 720
});

camera.start();
</script>

</body>
</html>